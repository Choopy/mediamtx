<!DOCTYPE html>
<html>
<head>
    <title>choopstrim</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        html, body {
	          background-color: black;
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            height: 100%;
        }

        .video-container {
            flex: 1;
            max-width: 1280px;
            margin: auto;
            position: relative;
        }

        #video {
            width: 100%;
            height: auto;
            background: rgb(30, 30, 30);
        }
	#message2 {
		position: absolute;
		left: 0;
		top: 0;
		width: 100%;
		height: 100%;
		display: flex;
		align-items: center;
		text-align: center;
		justify-content: center;
		font-size: 16px;
		font-weight: bold;
		color: white;
		pointer-events: none;
		padding: 20px;
		box-sizing: border-box;
		text-shadow: 0 0 5px black;
	}
        .chat-container {
            flex: 1;
            max-width: 300px;
            margin: auto;
            padding: 0 20px;
            position: relative;
            overflow: hidden;
        }

        .chat-messages {
            height: 500px; /* Adjust as needed */
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 0;
	           color: white;
        }

        .chat-input {
            padding: 10px;
        }

        .chat-input input[type="text"] {
            border: 1px solid #ccc;
            border-radius: 0;
            padding: 8px;
            margin-bottom: 10px;
            width: calc(100% - 10px);
            -webkit-appearance: none; /* Remove default styles for webkit browsers */
        }

        .chat-input .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
	           color: white;
        }

        .chat-input .name-input {
            flex: 1;
            margin-right: 10px;
        }

        .chat-input .send-button {
            border: 1px solid #ccc;
            border-radius: 0;
            padding: 8px 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="video-container">
        <video id="video"></video>
        <div id="message2"></div>
    </div>

    <div class="chat-container">
        <div class="chat-messages" id="chat">
            <!-- Chat messages will be displayed here -->
        </div>

        <form id="message-form" class="chat-input" method="post" action="">
            <input type="text" name="message" id="message" placeholder="" autocomplete="off">
            <div class="input-row">
                <label for="name">Name:</label>
                <input type="text" name="name" id="name" class="name-input" autocomplete="off">
                <input type="submit" value="Send" class="send-button">
            </div>
        </form>
    </div>
</div>
<script>
    $(document).ready(function() {
        // Function to fetch and display chat messages
        function fetchMessages() {
            $.ajax({
                url: "fetch_messages.php", // URL of the PHP script to fetch messages
                type: "GET",
                success: function(data) {
                    $("#chat").html(data); // Update chat messages
                    scrollChatToBottom(); // Scroll chat to bottom
                }
            });
        }

        // Function to scroll chat to bottom
        function scrollChatToBottom() {
            var chatContainer = document.getElementById("chat");
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Call fetchMessages() initially to display existing messages
        fetchMessages();

        // Submit form via AJAX
        $("#message-form").submit(function(event) {
            event.preventDefault(); // Prevent default form submission
            var formData = $(this).serialize(); // Serialize form data
            $.ajax({
                url: "send_message.php", // URL of the PHP script to send message
                type: "POST",
                data: formData,
                success: function() {
                    fetchMessages(); // Update chat messages after sending message
                    $("#message").val(""); // Clear message input field
                }
            });
        });
    });
</script>
<script>

const retryPause = 2000;

const video = document.getElementById('video');
const message = document.getElementById('message');

let defaultControls = false;

const setMessage = (str) => {
	if (str !== '') {
		video.controls = false;
	} else {
		video.controls = defaultControls;
	}
	message.innerText = str;
};

const loadStream = () => {
	// always prefer hls.js over native HLS.
	// this is because some Android versions support native HLS
	// but don't support fMP4s.
	if (Hls.isSupported()) {
		const hls = new Hls({
			maxLiveSyncPlaybackRate: 1.5,
		});

		hls.on(Hls.Events.ERROR, (evt, data) => {
			if (data.fatal) {
				hls.destroy();

				if (data.details === 'manifestIncompatibleCodecsError') {
					setMessage('stream makes use of codecs which are incompatible with this browser or operative system');
				} else if (data.response && data.response.code === 404) {
					setMessage('stream not found, retrying in some seconds');
				} else {
					setMessage(data.error + ', retrying in some seconds');
				}

				setTimeout(() => loadStream(video), retryPause);
			}
		});

		hls.on(Hls.Events.MEDIA_ATTACHED, () => {
			hls.loadSource('index.m3u8' + window.location.search);
		});

		hls.on(Hls.Events.MANIFEST_PARSED, () => {
			setMessage('');
			video.play();
		});

		hls.attachMedia(video);

	} else if (video.canPlayType('application/vnd.apple.mpegurl')) {
		// since it's not possible to detect timeout errors in iOS,
		// wait for the playlist to be available before starting the stream
		fetch('index.m3u8')
			.then(() => {
				video.src = 'index.m3u8';
				video.play();
			});
	}
};

const parseBoolString = (str, defaultVal) => {
	str = (str || '');

	if (['1', 'yes', 'true'].includes(str.toLowerCase())) {
		return true;
	}
	if (['0', 'no', 'false'].includes(str.toLowerCase())) {
		return false;
	}
	return defaultVal;
};

const loadAttributesFromQuery = () => {
	const params = new URLSearchParams(window.location.search);
	video.controls = parseBoolString(params.get('controls'), true);
	video.muted = parseBoolString(params.get('muted'), true);
	video.autoplay = parseBoolString(params.get('autoplay'), true);
	video.playsInline = parseBoolString(params.get('playsinline'), true);
	defaultControls = video.controls;
};

const init = () => {
	loadAttributesFromQuery();
	loadStream();
};

window.addEventListener('DOMContentLoaded', init);

</script>

</body>
</html>
